---
title: "metadata"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(dplyr)
```

# Obtain whole blood gene expression samples
```{r}
# Load the gene expression data
gene_expr_file <- "data/gene_reads_2017-06-05_v8_whole_blood.gct"
raw_count_df <- fread(gene_expr_file, header = TRUE)
raw_count_df <- raw_count_df[, -c(1:3)]

# modify GTEx sample names matching names used in PRS data
colnames(raw_count_df) <- sub("^(GTEX-[^-.]+).*", "\\1", colnames(raw_count_df))
```

# Match samples between PRS and count matrix
```{r}
# load PRS data for blood trait
prs_file <- "analysis/prs_blood_cell.txt"
prs_blood <- fread(prs_file, header = T, stringsAsFactors = FALSE)

# obtain GTEx sample id
id <- prs_blood$sample_id

# Load the PRS data for immune trait
prs_file <- "analysis/prs_immune.txt"
prs_immune <- fread(prs_file, header = T, stringsAsFactors = FALSE)

# subset samples
matching_samples <- intersect(id, colnames(raw_count_df))
prs_blood <- prs_blood[prs_blood$sample_id %in% matching_samples, ]
prs_immune <- prs_immune[prs_immune$sample_id %in% matching_samples, ]
```

# Stratify by PRS level (High vs Median vs Low)
## Blood trait
```{r}
# Loop through each column (starting from the second column, as the first column is sample_id)
for (i in 2:ncol(prs_blood)) {
  # Extract the PRS values for the current trait
  prs_trait <- prs_blood[[i]]

  # Calculate the 25th and 75th percentiles for the trait
  p25 <- quantile(prs_trait, 0.25, na.rm = TRUE)
  p75 <- quantile(prs_trait, 0.75, na.rm = TRUE)

  # Create a new column for the group classification based on the percentiles
  group <- ifelse(prs_trait > p75, "High", 
                  ifelse(prs_trait < p25, "Low", "Median"))

  # Assign the group to the new column for this trait
  prs_blood[[paste0("group_", colnames(prs_blood)[i])]] <- factor(group, 
                                      levels = c("Low", "Median", "High"))
}
```

## Immune trait
```{r}
# Loop through each column (starting from the second column, as the first column is sample_id)
for (i in 2:ncol(prs_immune)) {
  # Extract the PRS values for the current trait
  prs_trait <- prs_immune[[i]]

  # Calculate the 25th and 75th percentiles for the trait
  p25 <- quantile(prs_trait, 0.25, na.rm = TRUE)
  p75 <- quantile(prs_trait, 0.75, na.rm = TRUE)

  # Create a new column for the group classification based on the percentiles
  group <- ifelse(prs_trait > p75, "High", 
                  ifelse(prs_trait < p25, "Low", "Median"))

  # Assign the group to the new column for this trait
  prs_immune[[paste0("group_", colnames(prs_immune)[i])]] <- factor(group, 
                                      levels = c("Low", "Median", "High"))
}
```

# Whole blood covariates 
```{r}
cov_file <- "data/Whole_Blood.v8.covariates.txt"
cov <- fread(cov_file, header = T, stringsAsFactors = FALSE)
cov <- cov %>% filter(ID %in% c(paste0("PC", 1:5), "sex"))
col <- cov$ID
cov <- as.matrix(t(cov[, -1])) 
colnames(cov) <- col
```

# Combine for metadata
```{r}
metadata <- cbind(cov, prs_blood[,-1], prs_immune[,-1])
rownames(metadata) <- matching_samples
head(metadata)
#write.table(metadata, "analysis/metadata.txt", sep="\t", row.names = T, col.names = T, quote = F)
```



